<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="mybook">

	<!-- selectList -->
	<select id="selectList" resultType="MybookVo" parameterType="int">
		<![CDATA[
			select  r.review_no reviewNo,
        			b.book_title bookTitle,
        			b.book_no bookNo,
        			r.user_no userNo,
        			r.nickname,
        			r.review_content reviewContent,
        			r.style_no styleNo,
        			r.emo_name emoName,
        			NVL(r.likecnt,0) likecnt,
        			to_char(r.review_date, 'yyyy/mm/dd') reviewDate
			from   (select  r.review_no,
                			ru.likecnt,
                			r.style_no,
                			r.emo_name,
                			r.user_no,
                			r.book_no,
                			r.nickname,
                			r.review_content,
                			r.review_date
        			from   (select  r.review_no,
                        			s.style_no,
                        			e.emo_no,
                        			e.emo_name,
                        			r.book_no,
                        			u.user_no,
                        			u.nickname,
                        			r.review_content,
                        			r.review_date
                			from    review r, style s, emotion e, users u
                			where   e.emo_no = s.emo_no
                			and     r.style_no = s.style_no
                			and     r.user_no = u.user_no) r,(select review_no, count(review_no) likecnt
                                                    		  from review_user
                                                    		  group by review_no) ru
        			where r.review_no = ru.review_no(+)) r, books b
			where   r.book_no = b.book_no
			and r.user_no = #{userNo}
			ORDER BY reviewDate desc
		]]>

	</select>
	
	<!-- paging이 적용된 리스트 가져오기 -->
	<select id="getList2" parameterType="map" resultType="MybookVo">
		<![CDATA[
			select rn,
			       reviewNo,
			       bookTitle,
			       bookNo,
			       userNo,
			       nickname,
			       reviewContent,
			       styleNo,
			       emoName,
			       likecnt,
			       reviewDate
			from (select rownum rn,
			           reviewNo,
			           bookTitle,
			           bookNo,
			           userNo,
			           nickname,
			           reviewContent,
			           styleNo,
			           emoName,
			           likecnt,
			           reviewDate
			        from (select r.review_no reviewNo,
			                b.book_title bookTitle,
			                b.book_no bookNo,
			                r.user_no userNo,
			                r.nickname,
			                r.review_content reviewContent,
			                r.style_no styleNo,
			                r.emo_name emoName,
			                NVL(r.likecnt,0) likecnt,
			                to_char(r.review_date, 'yyyy/mm/dd') reviewDate
			        from   (select  r.review_no,
			                        ru.likecnt,
			                        r.style_no,
			                        r.emo_name,
			                        r.user_no,
			                        r.book_no,
			                        r.nickname,
			                        r.review_content,
			                        r.review_date
			                from   (select  r.review_no,
			                                s.style_no,
			                                e.emo_no,
			                                e.emo_name,
			                                r.book_no,
			                                u.user_no,
			                                u.nickname,
			                                r.review_content,
			                                r.review_date
			                        from    review r, style s, emotion e, users u
			                        where   e.emo_no = s.emo_no
			                        and     r.style_no = s.style_no
			                        and     r.user_no = u.user_no) r,(select review_no, count(review_no) likecnt
			                                                          from review_user
			                                                          group by review_no) ru
			                where r.review_no = ru.review_no(+)) r, books b
			        where   r.book_no = b.book_no
			        and r.user_no = #{userNo}
			        ORDER BY reviewDate desc))
			where rn between #{startNum} and #{endNum}			
		]]>
	</select>
	
	<!-- paging이 적용된 리스트 가져오기 (+ 좋아요 여부 likecheck)-->
	<select id="getList3" parameterType="map" resultType="MybookVo">
		<![CDATA[
			select rn,
			        review_no reviewNo,
			        lon likecheck,
			        likecnt,
			        style_no styleNo,
			        emo_no emoNo,
			        emo_name emoName,
			        book_no bookNo,
			        book_title bookTitle,
			        user_no userNo,
			        nickname,
			        review_content reviewContent,
			        to_char(review_date, 'yyyy/mm/dd') reviewDate
			from(select  rownum rn,
			            review_no,
			            lon,
			            likecnt,
			            style_no,
			            emo_no,
			            emo_name,
			            book_no,
			            book_title,
			            user_no,
			            nickname,
			            review_content,
			            review_date
			    from (select  r.review_no,
			            NVL(lont.user_no, 0) lon,
			            NVL(lct.likecnt, 0) likecnt,
			            s.style_no,
			            e.emo_no,
			            e.emo_name,
			            r.book_no,
			            b.book_title,
			            u.user_no,
			            u.nickname,
			            r.review_content,
			            r.review_date
			    from    review r, style s, emotion e, users u, books b, (select review_no, 
			                                                                    count(review_no) likecnt
			                                                              from review_user
			                                                              group by review_no) lct, (select review_no,
			                                                                                               user_no
			                                                                                        from review_user
			                                                                                        where user_no = #{nowuserNo}) lont
			    where   e.emo_no = s.emo_no
			    and     r.style_no = s.style_no
			    and     r.user_no = u.user_no
			    and     r.book_no = b.book_no
			    and     r.review_no = lct.review_no(+)
			    and     r.review_no = lont.review_no(+)
			    and     r.user_no = #{userNo}
			    order by r.review_date desc))
			where rn between #{startNum} and #{endNum}		
		]]>
	</select>
	
	<!-- selectpopular -->
	<select id="selectpopular" resultType="MybookVo" parameterType="int">
		<![CDATA[
			select  r.review_no reviewNo,
        			b.book_title bookTitle,
        			b.book_no bookNo,
        			r.user_no userNo,
        			r.nickname,
        			r.review_content reviewContent,
        			r.style_no styleNo,
        			r.emo_name emoName,
        			NVL(r.likecnt,0) likecnt,
        			to_char(r.review_date, 'yyyy/mm/dd') reviewDate
			from   (select  r.review_no,
                			ru.likecnt,
                			r.style_no,
                			r.emo_name,
                			r.user_no,
                			r.book_no,
                			r.nickname,
                			r.review_content,
                			r.review_date
        			from   (select  r.review_no,
                        			s.style_no,
                        			e.emo_no,
                        			e.emo_name,
                        			r.book_no,
                        			u.user_no,
                        			u.nickname,
                        			r.review_content,
                        			r.review_date
                			from    review r, style s, emotion e, users u
                			where   e.emo_no = s.emo_no
                			and     r.style_no = s.style_no
                			and     r.user_no = u.user_no) r,(select review_no, count(review_no) likecnt
                                                    		  from review_user
                                                    		  group by review_no) ru
        			where r.review_no = ru.review_no(+)) r, books b
			where   r.book_no = b.book_no
			and r.user_no = #{userNo}
			ORDER BY likecnt desc
		]]>

	</select>
	
	<!-- selectpopular + 페이징 기능 -->
	<select id="selectpopular2" parameterType="map" resultType="MybookVo">
		<![CDATA[
			select rn,
			       reviewNo,
			       bookTitle,
			       bookNo,
			       userNo,
			       nickname,
			       reviewContent,
			       styleNo,
			       emoName,
			       likecnt,
			       reviewDate 
			from (select rownum rn,
			           reviewNo,
			           bookTitle,
			           bookNo,
			           userNo,
			           nickname,
			           reviewContent,
			           styleNo,
			           emoName,
			           likecnt,
			           reviewDate
			    from(select  r.review_no reviewNo,
			                b.book_title bookTitle,
			                b.book_no bookNo,
			                r.user_no userNo,
			                r.nickname,
			                r.review_content reviewContent,
			                r.style_no styleNo,
			                r.emo_name emoName,
			                NVL(r.likecnt,0) likecnt,
			                to_char(r.review_date, 'yyyy/mm/dd') reviewDate
			        from   (select  r.review_no,
			                        ru.likecnt,
			                        r.style_no,
			                        r.emo_name,
			                        r.user_no,
			                        r.book_no,
			                        r.nickname,
			                        r.review_content,
			                        r.review_date
			                from   (select  r.review_no,
			                                s.style_no,
			                                e.emo_no,
			                                e.emo_name,
			                                r.book_no,
			                                u.user_no,
			                                u.nickname,
			                                r.review_content,
			                                r.review_date
			                        from    review r, style s, emotion e, users u
			                        where   e.emo_no = s.emo_no
			                        and     r.style_no = s.style_no
			                        and     r.user_no = u.user_no) r,(select review_no, count(review_no) likecnt
			                                                          from review_user
			                                                          group by review_no) ru
			                where r.review_no = ru.review_no(+)) r, books b
			        where   r.book_no = b.book_no
			        and r.user_no = #{userNo}
			        ORDER BY likecnt desc))
			where rn between #{startNum} and #{endNum}		
		]]>
	</select>
	
	<select id="selectpopular3" parameterType="map" resultType="MybookVo">
		<![CDATA[
			select rn,
			        review_no reviewNo,
			        lon likecheck,
			        likecnt,
			        style_no styleNo,
			        emo_no emoNo,
			        emo_name emoName,
			        book_no bookNo,
			        book_title bookTitle,
			        user_no userNo,
			        nickname,
			        review_content reviewContent,
			        to_char(review_date, 'yyyy/mm/dd') reviewDate
			from(select  rownum rn,
			            review_no,
			            lon,
			            likecnt,
			            style_no,
			            emo_no,
			            emo_name,
			            book_no,
			            book_title,
			            user_no,
			            nickname,
			            review_content,
			            review_date
			    from (select  r.review_no,
			            NVL(lont.user_no, 0) lon,
			            NVL(lct.likecnt, 0) likecnt,
			            s.style_no,
			            e.emo_no,
			            e.emo_name,
			            r.book_no,
			            b.book_title,
			            u.user_no,
			            u.nickname,
			            r.review_content,
			            r.review_date
			    from    review r, style s, emotion e, users u, books b, (select review_no, 
			                                                                    count(review_no) likecnt
			                                                              from review_user
			                                                              group by review_no) lct, (select review_no,
			                                                                                               user_no
			                                                                                        from review_user
			                                                                                        where user_no = #{nowuserNo}) lont
			    where   e.emo_no = s.emo_no
			    and     r.style_no = s.style_no
			    and     r.user_no = u.user_no
			    and     r.book_no = b.book_no
			    and     r.review_no = lct.review_no(+)
			    and     r.review_no = lont.review_no(+)
			    and     r.user_no = #{userNo}
			    order by likecnt desc))
			where rn between  #{startNum} and #{endNum}			
		]]>
	</select>

	<select id="totalCnt" parameterType="int" resultType="int">
		<![CDATA[
			select count(*)
			from (select r.review_no reviewNo,
			        b.book_title bookTitle,
			        b.book_no bookNo,
			        r.user_no userNo,
			        r.nickname,
			        r.review_content reviewContent,
			        r.style_no styleNo,
			        r.emo_name emoName,
			        NVL(r.likecnt,0) likecnt,
			        to_char(r.review_date, 'yyyy/mm/dd') reviewDate
			from   (select  r.review_no,
			                ru.likecnt,
			                r.style_no,
			                r.emo_name,
			                r.user_no,
			                r.book_no,
			                r.nickname,
			                r.review_content,
			                r.review_date
			        from   (select  r.review_no,
			                        s.style_no,
			                        e.emo_no,
			                        e.emo_name,
			                        r.book_no,
			                        u.user_no,
			                        u.nickname,
			                        r.review_content,
			                        r.review_date
			                from    review r, style s, emotion e, users u
			                where   e.emo_no = s.emo_no
			                and     r.style_no = s.style_no
			                and     r.user_no = u.user_no) r,(select review_no, count(review_no) likecnt
			                                                  from review_user
			                                                  group by review_no) ru
			        where r.review_no = ru.review_no(+)) r, books b
			where   r.book_no = b.book_no
			and r.user_no = #{userNo}
			ORDER BY reviewDate desc)			
		]]>
	</select>
	
	<!-- checklike -->
	<select id="checklike" resultType="MybookVo" parameterType="MybookVo">
		<![CDATA[
			select  user_no userNo,
       				review_no reviewNo
			from review_user
			where user_no = #{userNo}
			and review_no = #{reviewNo}
		]]>
	</select>
	
	<!-- like -->
	<insert id="like" parameterType="MybookVo">
		<![CDATA[
			insert into review_user
			values(SEQ_REVIEW_USER_NO.nextval, #{userNo}, #{reviewNo}, sysdate)
		]]>
	</insert>
	
	<!-- dislike -->
	<delete id="dislike" parameterType="MybookVo">
		<![CDATA[
			delete from review_user
			where user_no = #{userNo}
			and review_no = #{reviewNo}
		]]>
	</delete>
	
	
	<!-- checklikecount -->
	<select id="checklikecnt" resultType="MybookVo" parameterType="MybookVo">
		<![CDATA[
			select  r.review_no reviewNo,
        			r.user_no userNo,
        			r.nickname,
        			NVL(r.likecnt,0) likecnt
			from   (select  r.review_no,
                			ru.likecnt,
                			r.style_no,
                			r.emo_name,
                			r.user_no,
                			r.book_no,
                			r.nickname,
                			r.review_content,
                			r.review_date
        			from   (select  r.review_no,
                        			s.style_no,
                        			e.emo_no,
                        			e.emo_name,
                        			r.book_no,
                        			u.user_no,
                        			u.nickname,
                        			r.review_content,
                        			r.review_date
                			from    review r, style s, emotion e, users u
                			where   e.emo_no = s.emo_no
                			and     r.style_no = s.style_no
                			and     r.user_no = u.user_no) r,(select review_no, count(review_no) likecnt
                                                  			from review_user
                                                  			group by review_no) ru
        			where r.review_no = ru.review_no(+)) r, books b
					where   r.book_no = b.book_no
					and r.review_no = #{reviewNo}
		]]>
	</select>
	
	<!-- 좋아요 최신순에따른 ,유저 n번이 좋아요한 서평 -->
	<!-- like1 -->
	<select id="like1" resultType="MybookVo" parameterType="int">
		<![CDATA[
			select  r.reviewLikeDate,
			        r.reviewNo,
			        r.bookTitle,
			        r.bookNo,
			        r.userNo,
			        r.nickname,
			        r.reviewContent,
			        r.styleNo,
			        r.emoName,
			        NVL(r.likecnt,0) likecnt,
			        r.reviewDate
			from (select    ru.review_like_date reviewLikeDate,
			                r.reviewNo,
			                r.bookTitle,
			                r.bookNo,
			                r.userNo,
			                r.nickname,
			                r.reviewContent,
			                r.styleNo,
			                r.emoName,
			                r.likecnt,
			                r.reviewDate
			        from (select  r.review_no reviewNo,
			                    b.book_title bookTitle,
			                    b.book_no bookNo,
			                    r.user_no userNo,
			                    r.nickname,
			                    r.review_content reviewContent,
			                    r.style_no styleNo,
			                    r.emo_name emoName,
			                    r.likecnt,
			                    to_char(r.review_date, 'yyyy/mm/dd') reviewDate
			            from   (select    r.review_no,
			                                ru.likecnt,
			                                r.style_no,
			                                r.emo_name,
			                                r.user_no,
			                                r.book_no,
			                                r.nickname,
			                                r.review_content,
			                                r.review_date
			                    from   (select   r.review_no,
			                                        s.style_no,
			                                        e.emo_no,
			                                        e.emo_name,
			                                        r.book_no,
			                                        u.user_no,
			                                        u.nickname,
			                                        r.review_content,
			                                        r.review_date
			                                from    review r, style s, emotion e, users u
			                                where   e.emo_no = s.emo_no
			                                and     r.style_no = s.style_no
			                                and     r.user_no = u.user_no) r,(select review_no, count(review_no) likecnt
			                                                                from review_user
			                                                                group by review_no) ru
			                    where r.review_no = ru.review_no(+)) r, books b
			            where   r.book_no = b.book_no) r, review_user ru
			        where ru.review_no = r.reviewNo
			        and user_no = #{userNo}
			        ORDER BY reviewLikeDate desc) r
			where rownum <= 1
		]]>
	</select>
	
	
	<!-- 유저 n번이 좋아요한 서평리스트 -->
	<!-- likelist -->
	<select id="likelist" resultType="MybookVo" parameterType="int">
		<![CDATA[
			select r.reviewLikeDate,
	                r.reviewNo,
	                r.bookTitle,
	                r.bookNo,
	                r.userNo,
	                r.nickname,
	                r.reviewContent,
	                r.styleNo,
	                r.emoName,
	                NVL(r.likecnt,0) likecnt,
	                r.reviewDate,
	                r.user_profile userPro
	from (select    ru.review_like_date reviewLikeDate,
	                r.reviewNo,
	                r.bookTitle,
	                r.bookNo,
	                r.userNo,
	                r.nickname,
	                r.reviewContent,
	                r.styleNo,
	                r.emoName,
	                r.likecnt,
	                r.reviewDate,
	                r.user_profile
	        from (select  r.review_no reviewNo,
	                    b.book_title bookTitle,
	                    b.book_no bookNo,
	                    r.user_no userNo,
	                    r.nickname,
	                    r.review_content reviewContent,
	                    r.style_no styleNo,
	                    r.emo_name emoName,
	                    r.likecnt,
	                    r.user_profile,
	                    to_char(r.review_date, 'yyyy/mm/dd') reviewDate
	            from   (select    r.review_no,
	                                ru.likecnt,
	                                r.style_no,
	                                r.emo_name,
	                                r.user_no,
	                                r.book_no,
	                                r.nickname,
	                                r.review_content,
	                                r.review_date,
	                                r.user_profile
	                    from   (select   r.review_no,
	                                        s.style_no,
	                                        e.emo_no,
	                                        e.emo_name,
	                                        r.book_no,
	                                        u.user_no,
	                                        u.nickname,
	                                        r.review_content,
	                                        r.review_date,
	                                        u.user_profile
	                                from    review r, style s, emotion e, users u
	                                where   e.emo_no = s.emo_no
	                                and     r.style_no = s.style_no
	                                and     r.user_no = u.user_no) r,(select review_no, count(review_no) likecnt
	                                                                from review_user
	                                                                group by review_no) ru
	                    where r.review_no = ru.review_no(+)) r, books b
	            where   r.book_no = b.book_no) r, review_user ru
	        where ru.review_no = r.reviewNo
	        and user_no = #{userNo}
	        ORDER BY reviewLikeDate desc) r
	        where rownum <= 4
		]]>
	</select>
	
	<!-- 유저 n번의 서평 총 갯수 : likecheck는 그냥 임의로 갖다 씀 -->
	<!-- reviewcnt -->
	<select id="reviewcnt" resultType="MybookVo" parameterType="int">
		<![CDATA[
			select count(review_no) likecheck
			from review
			where user_no = #{userNo}
		]]>
	</select>
	
	<!-- 리뷰넘버 n의 유저넘버 -->
	<!-- checkuser -->
	<select id="checkuser" resultType="MybookVo" parameterType="int">
		<![CDATA[
			select  user_no userNo,
        			review_no reviewNo
			from review
			where review_no = #{reviewNo}
		]]>
	</select>
	
	<!-- 리뷰넘버 n번의 삭제 -->
	<!-- delete -->
	<delete id="delete" parameterType="int">
		<![CDATA[
			DELETE FROM review WHERE review_no = #{reviewNo}
		]]>
	</delete>
	
	<!-- 유저번호, 감정태그 주면은 해당 감정태그 서평만 출력 -->
	<!-- emoList -->
	<select id="emoList" resultType="MybookVo" parameterType="int">
		<![CDATA[
			select  r.review_no reviewNo, 
        			NVL(ru.likecnt,0) likecnt,
        			r.style_no styleNo,
        			r.emo_no emoNo,
        			r.emo_name emoName,
        			r.book_no bookNo,
        			r.book_title bookTitle,
        			r.user_no userNo,
        			r.nickname,
        			r.review_content reviewContent,
        			r.review_date reviewDate
			from (select    r.review_no,        
                			s.style_no,
                			e.emo_no,
                			e.emo_name,
                			r.book_no,
                			b.book_title,
                			u.user_no,
                			u.nickname,
                			r.review_content,
                			r.review_date
        			from    review r, style s, emotion e, users u, books b
        			where   e.emo_no = s.emo_no
        			and     r.style_no = s.style_no
        			and     r.user_no = u.user_no
        			and     b.book_no = r.book_no
        			order by r.review_date desc ) r, (select review_no, count(review_no) likecnt
                                            			from review_user
                                            			group by review_no) ru
			where r.review_no = ru.review_no(+)
			and r.user_no= #{userNo}
			and emo_name = #{emoName}		
		]]>
	</select>
	
	<!-- 페이징 기능 + 감정 분류 서평 리스트 -->
	<select id="emoList2" parameterType="map" resultType="MybookVo">
		<![CDATA[
			select rn, 
			       reviewNo,
			       likecnt,
			       styleNo,
			       emoNo,
			       emoName,
			       bookNo,
			       bookTitle,
			       userNo,
			       nickname,
			       reviewContent,
			       reviewDate
			from (select  rownum rn,
			            r.review_no reviewNo, 
			            NVL(ru.likecnt,0) likecnt,
			            r.style_no styleNo,
			            r.emo_no emoNo,
			            r.emo_name emoName,
			            r.book_no bookNo,
			            r.book_title bookTitle,
			            r.user_no userNo,
			            r.nickname,
			            r.review_content reviewContent,
			            r.review_date reviewDate
			    from (select    r.review_no,        
			                    s.style_no,
			                    e.emo_no,
			                    e.emo_name,
			                    r.book_no,
			                    b.book_title,
			                    u.user_no,
			                    u.nickname,
			                    r.review_content,
			                    r.review_date
			            from    review r, style s, emotion e, users u, books b
			            where   e.emo_no = s.emo_no
			            and     r.style_no = s.style_no
			            and     r.user_no = u.user_no
			            and     b.book_no = r.book_no
			            order by r.review_date desc ) r, (select review_no, count(review_no) likecnt
			                                                from review_user
			                                                group by review_no) ru
			    where r.review_no = ru.review_no(+)
			    and r.user_no= #{userNo}
			    and r.emo_name = #{emoName})
			where rn between #{startNum} and #{endNum}
		]]>
	</select>
	
	<select id="emoList3" parameterType="map" resultType="MybookVo">
		<![CDATA[
			select rn,
			        review_no reviewNo,
			        lon likecheck,
			        likecnt,
			        style_no styleNo,
			        emo_no emoNo,
			        emo_name emoName,
			        book_no bookNo,
			        book_title bookTitle,
			        user_no userNo,
			        nickname,
			        review_content reviewContent,
			        to_char(review_date, 'yyyy/mm/dd') reviewDate
			from(select  rownum rn,
			            review_no,
			            lon,
			            likecnt,
			            style_no,
			            emo_no,
			            emo_name,
			            book_no,
			            book_title,
			            user_no,
			            nickname,
			            review_content,
			            review_date
			    from (select  r.review_no,
			            NVL(lont.user_no, 0) lon,
			            NVL(lct.likecnt, 0) likecnt,
			            s.style_no,
			            e.emo_no,
			            e.emo_name,
			            r.book_no,
			            b.book_title,
			            u.user_no,
			            u.nickname,
			            r.review_content,
			            r.review_date
			    from    review r, style s, emotion e, users u, books b, (select review_no, 
			                                                                    count(review_no) likecnt
			                                                              from review_user
			                                                              group by review_no) lct, (select review_no,
			                                                                                               user_no
			                                                                                        from review_user
			                                                                                        where user_no = #{nowuserNo}) lont
			    where   e.emo_no = s.emo_no
			    and     r.style_no = s.style_no
			    and     r.user_no = u.user_no
			    and     r.book_no = b.book_no
			    and     r.review_no = lct.review_no(+)
			    and     r.review_no = lont.review_no(+)
			    and     r.user_no = #{userNo}
			    and		e.emo_name = #{emoName}
			    order by likecnt desc))
			where rn between  #{startNum} and #{endNum}					
		]]>
	</select>
	
	<select id="getPlaylist" parameterType="map" resultType="PlaylistVo">
		<![CDATA[
			select p.playlist_name playlistName,
			       p.playlist_no playlistNo,
			       e.emo_name emoName,
			       u.nickname,
			       u.user_no userNo,
			       NVL(nt.review_no, 0) likeuser
			from playlist p, emotion e, users u, (select p.playlist_no,
			                                       pr.review_no
			                                from playlist p, playlist_review pr
			                                where p.playlist_no = pr.playlist_no
			                                and pr.review_no = #{reviewNo}) nt
			where p.user_no = u.user_no
			and e.emo_no = p.emo_no
			and p.playlist_no = nt.playlist_no(+)
			and u.user_no = #{userNo}			
		]]>
	</select>
</mapper>